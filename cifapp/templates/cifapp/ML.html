<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CIF File Upload</title>
    <script>const csrfToken = "{{ csrf_token }}";</script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        h1 {
            text-align: center;
        }
        .navbar {
            background-color: #660874;
            overflow: hidden;
        }
        .navbar a {
            float: left;
            display: block;
            color: white;
            text-align: center;
            padding: 14px 20px;
            text-decoration: none;
        }
        .navbar a:hover {
            background-color: #603ea8;
        }
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
            min-height: 600px;
        }
        .upload-box {
            border: 2px dashed #cccccc;
            border-radius: 10px;
            text-align: center;
            padding: 40px;
            cursor: pointer;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        .upload-box:hover {
            border-color: #888888;
        }
        .upload-box.highlight {
            border-color: #660874;
            background-color: #f0e6f2;
        }
        .upload-box input[type="file"] {
            display: none;
        }
        .top-buttons {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
        }
        .top-buttons button {
            width: 200px;
            background-color: #4CAF50;
            color: white;
            font-size: 16px;
            padding: 12px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
        }
        .plot-area {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-top: 30px;
        }
        .plot-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            max-width: 300px;
        }
        .plot-group button {
            width: 170px;
            padding: 12px;
            font-size: 16px;
            color: #ffffff;
            background-color: #4CAF50;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 10px;
        }
        .plot-box {
            width: 100%;
            border: 2px dashed #999;
            border-radius: 10px;
            min-height: 300px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            padding: 10px;
            background-color: #f9f9f9;
            margin-bottom: 20px;
        }
        .plot-box img {
            width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 8px;
            display: none;
        }
        
        /* -------- 特征工程区域独立样式 -------- */
        .feature-box {
            width: 100%;
            border: 2px dashed #999;
            border-radius: 10px;
            min-height: 320px; /* 固定高度 */
            height: 320px;
            display: flex;
            justify-content: space-around; /* 三图水平分布 */
            align-items: center;
            position: relative;
            padding: 10px 15px;
            background-color: #f9f9f9;
            margin-bottom: 20px;
            overflow: hidden; /* 防止被撑开 */
        }
        
        .feature-box img {
            width: 30%;          /* 每张图占 30% 宽度 */
            height: 90%;         /* 高度为框的 90% */
            object-fit: contain; /* 保持比例 */
            border-radius: 8px;
            display: none;       /* 默认隐藏 */
        }
        
        /* loading 层 */
        .feature-box .loading {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(255,255,255,0.8);
            font-weight: bold;
            color: #660874;
        }

        .loading {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(255,255,255,0.8);
            font-weight: bold;
            color: #660874;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid #660874;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-top: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error {
            color: #d9534f;
            padding: 10px;
            text-align: center;
            font-weight: bold;
        }
        .result-box {
            width: 100%;
            border: 2px dashed #999;
            border-radius: 10px;
            min-height: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f9f9f9;
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.4);
        }
        .modal-content {
            background: #fff;
            margin: 10% auto;
            padding: 20px;
            border-radius: 12px;
            width: 60%;
            font-size: 14px;
            line-height: 1.6;
            max-height: 70%;
            overflow-y: auto;
        }
        .close {
            float: right;
            font-size: 20px;
            cursor: pointer;
        }

        /* 新布局：特征工程三行三列 */
        .feature-area {
            display: flex;
            flex-direction: column;
            gap: 30px;
            margin-top: 40px;
        }
        .feature-row {
            display: flex;
            gap: 20px;
        }
        .feature-row .plot-group {
            flex: 1;
            max-width: none;
        }
        .feature-row button {
            width: 200px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <a href="{% url 'home' %}">Home</a>
        <a href="{% url 'calculate' %}">Project</a>
        <a href="{% url 'record_list' %}">Database</a>
        <a href="{% url 'ML' %}">ML</a>
        <a href="{% url 'illustration' %}">Support</a>
        <a href="{% url 'about' %}">About</a>
    </div>
    
    <div class="container">
        <h1>Machine Learning</h1>
        
        <div class="top-buttons">
            <button onclick="openModal('modal1')">Built-in data training</button>
            <button onclick="openModal('modal2')">Custom data training</button>
        </div>

        <!-- 模态框内容保持不变 -->
        <div id="modal1" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('modal1')">&times;</span>
                <p style="font-size:18px; font-weight:bold; font-style:italic;">Message from crystructanalysis.com:</p>
                <p>Users can download the required data from the Database page to form a database. It is recommended to download as many records as possible to achieve ideal results.</p>
            </div>
        </div>
        <div id="modal2" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('modal2')">&times;</span>
                <p style="font-size:18px; font-weight:bold; font-style:italic;">Message from crystructanalysis.com:</p>
                <p>Users can upload their own databases containing data.</p>
                <p><b>Regarding databases and results, please note the following:</b></p>
                <ol>
                    <li>The database file format must end with <code>.xlsx</code> or <code>.xls</code>.</li>
                    <li>The first column of attributes will default to the material name in the backend and will not be used for training.</li>
                    <li>The more data entries, the better the training results.</li>
                    <li>It is normal for the blocks in the image to deviate from the diagonal, indicating that the model has generalized.</li>
                    <li>The closer the R² is to 1, the closer the model's predicted values are to the true values. RMSE is an absolute error metric and should be considered in conjunction with the magnitude of the data; a smaller RMSE indicates a lower prediction error.</li>
                </ol>
            </div>
        </div>

        <!-- Excel 上传 -->
        <form id="upload-form" method="post" enctype="multipart/form-data" action="#">
            {% csrf_token %}
            <label class="upload-box" id="upload-box">
                Drag & Drop an Excel File Here or Click to Upload
                <input type="file" name="excel_file" id="file-input" accept=".xlsx, .xls" />
            </label>
        </form>

        <!-- 三算法展示区 -->
        <div class="plot-area">
            <div class="plot-group">
                <button type="button" id="rf-btn">RF</button>
                <div class="plot-box" id="rf-box">
                    <img id="rf-img" alt="RF Plot" />
                    <div class="loading" id="rf-loading">
                        Processing...
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
            <div class="plot-group">
                <button type="button" id="gbdt-btn">GBRT</button>
                <div class="plot-box" id="gbdt-box">
                    <img id="gbdt-img" alt="GBRT Plot" />
                    <div class="loading" id="gbdt-loading">
                        Processing...
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
            <div class="plot-group">
                <button type="button" id="xgb-btn">XGBoost</button>
                <div class="plot-box" id="xgb-box">
                    <img id="xgb-img" alt="XGBoost Plot" />
                    <div class="loading" id="xgb-loading">
                        Processing...
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 特征工程区域 -->
        <h2 style="margin-top:50px; text-align:center;">Feature Engineering Analysis</h2>
        <div class="feature-area">
            <!-- SHAP 行 -->
            <div class="feature-row">
                <div class="plot-group">
                    <button type="button" onclick="handleFeatureRowClick('shap')">SHAP Beeswarm</button>
                    <div class="feature-box">
                        <img id="shap-rf-img" alt="SHAP RF" />
                        <img id="shap-gbdt-img" alt="SHAP GBRT" />
                        <img id="shap-xgb-img" alt="SHAP XGBoost" />
                        <div class="loading" id="shap-loading">
                            Generating SHAP...
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Bubble 行 -->
            <div class="feature-row">
                <div class="plot-group">
                    <button type="button" onclick="handleFeatureRowClick('bubble')">Bubble Matrix</button>
                    <div class="feature-box">
                        <img id="bubble-rf-img" alt="Bubble RF" />
                        <img id="bubble-gbdt-img" alt="Bubble GBRT" />
                        <img id="bubble-xgb-img" alt="Bubble XGBoost" />
                        <div class="loading" id="bubble-loading">
                            Generating Bubble...
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Pareto 行 -->
            <div class="feature-row">
                <div class="plot-group">
                    <button type="button" onclick="handleFeatureRowClick('pareto')">Pareto Chart</button>
                    <div class="feature-box">
                        <img id="pareto-rf-img" alt="Pareto RF" />
                        <img id="pareto-gbdt-img" alt="Pareto GBRT" />
                        <img id="pareto-xgb-img" alt="Pareto XGBoost" />
                        <div class="loading" id="pareto-loading">
                            Generating Pareto...
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 单条数据预测功能保持不变 -->
        <h2 style="margin-top:50px; text-align:center;">Target attribute prediction</h2>
        <form id="predict-form" method="post" enctype="multipart/form-data" action="#">
            {% csrf_token %}
            <label class="upload-box" id="predict-upload-box">
                Drag & Drop a Single Row File Here or Click to Upload
                <input type="file" name="predict_file" id="predict-file-input" accept=".xlsx, .xls, .csv" />
            </label>
        </form>

        <div class="plot-area">
            <div class="plot-group">
                <button type="button" id="rf-predict-btn">RF-predict</button>
                <div class="result-box" id="rf-predict-box">Waiting for prediction...</div>
            </div>
            <div class="plot-group">
                <button type="button" id="gbdt-predict-btn">GBRT-predict</button>
                <div class="result-box" id="gbdt-predict-box">Waiting for prediction...</div>
            </div>
            <div class="plot-group">
                <button type="button" id="xgb-predict-btn">XGBoost-predict</button>
                <div class="result-box" id="xgb-predict-box">Waiting for prediction...</div>
            </div>
        </div>
    </div>

<script>
    const uploadBox = document.getElementById('upload-box');
    const fileInput = document.getElementById('file-input');

    function handleModelButtonClick(modelType, imageId, loadingId) {
        if (fileInput.files.length === 0) { alert("Please select an Excel file first."); return; }
        const img = document.getElementById(imageId);
        const loading = document.getElementById(loadingId);
        img.style.display = "none";
        loading.style.display = "flex";
        const formData = new FormData();
        formData.append("excel_file", fileInput.files[0]);
        formData.append("model", modelType);
        fetch("{% url 'process_excel' %}", {
            method: "POST",
            headers: { "X-CSRFToken": csrfToken },
            body: formData,
        })
        .then(r => r.json())
        .then(data => {
            loading.style.display = "none";
            if (data.status==="ok" && data.image_url){ img.src = data.image_url; img.style.display="block"; }
            else if (data.status==="error"){ alert("Error: "+data.message);}
            else { alert("Invalid response from server");}
        })
        .catch(err => { loading.style.display="none"; alert("Network/JS Error: "+err.message); });
    }

    document.getElementById("rf-btn").addEventListener("click", ()=>handleModelButtonClick("rf","rf-img","rf-loading"));
    document.getElementById("gbdt-btn").addEventListener("click", ()=>handleModelButtonClick("gbdt","gbdt-img","gbdt-loading"));
    document.getElementById("xgb-btn").addEventListener("click", ()=>handleModelButtonClick("xgb","xgb-img","xgb-loading"));

    // 文件拖放功能（训练）
    uploadBox.addEventListener('dragover', e=>{ e.preventDefault(); uploadBox.classList.add('highlight'); });
    uploadBox.addEventListener('dragleave', ()=>uploadBox.classList.remove('highlight'));
    uploadBox.addEventListener('drop', e=>{
        e.preventDefault(); uploadBox.classList.remove('highlight');
        if (e.dataTransfer.files.length){ fileInput.files = e.dataTransfer.files; uploadBox.textContent=`File selected: ${e.dataTransfer.files[0].name}`; }
    });
    fileInput.addEventListener('change', ()=>{ if(fileInput.files.length){ uploadBox.textContent=`File selected: ${fileInput.files[0].name}`;} });

    // 预测逻辑
    const predictUploadBox = document.getElementById('predict-upload-box');
    const predictFileInput = document.getElementById('predict-file-input');
    function handlePredictButtonClick(modelType,resultId){
        if(!predictFileInput.files.length){ alert("Please select a prediction file first."); return; }
        const resultBox = document.getElementById(resultId);
        resultBox.textContent = "Predicting...";
        const formData = new FormData();
        formData.append("predict_file", predictFileInput.files[0]);
        formData.append("model", modelType);
        fetch("{% url 'predict' %}", { method:"POST", headers:{"X-CSRFToken":csrfToken}, body:formData})
        .then(r=>r.json()).then(data=>{
            if(data.prediction!==undefined){ resultBox.textContent="Prediction: "+data.prediction; }
            else{ resultBox.textContent="Error: "+data.error; }
        }).catch(err=>{ resultBox.textContent="Network/JS Error: "+err.message; });
    }
    document.getElementById("rf-predict-btn").addEventListener("click", ()=>handlePredictButtonClick("rf","rf-predict-box"));
    document.getElementById("gbdt-predict-btn").addEventListener("click", ()=>handlePredictButtonClick("gbdt","gbdt-predict-box"));
    document.getElementById("xgb-predict-btn").addEventListener("click", ()=>handlePredictButtonClick("xgb","xgb-predict-box"));

    predictUploadBox.addEventListener('dragover', e=>{ e.preventDefault(); predictUploadBox.classList.add('highlight'); });
    predictUploadBox.addEventListener('dragleave', ()=>predictUploadBox.classList.remove('highlight'));
    predictUploadBox.addEventListener('drop', e=>{
        e.preventDefault(); predictUploadBox.classList.remove('highlight');
        if(e.dataTransfer.files.length){ predictFileInput.files=e.dataTransfer.files; predictUploadBox.textContent=`File selected: ${e.dataTransfer.files[0].name}`;}
    });
    predictFileInput.addEventListener('change', ()=>{ if(predictFileInput.files.length){ predictUploadBox.textContent=`File selected: ${predictFileInput.files[0].name}`;} });

    // 模态框函数
    function openModal(id){ document.getElementById(id).style.display="block"; }
    function closeModal(id){ document.getElementById(id).style.display="none"; }

    // ---------------- 新增特征工程行逻辑 ----------------
    function handleFeatureRowClick(type){
        if(!fileInput.files.length){ alert("Please select an Excel file first."); return; }
        const models = ["rf","gbdt","xgb"];
        models.forEach(model=>{
            const img = document.getElementById(`${type}-${model}-img`);
            const loading = document.getElementById(`${type}-loading`);
            img.style.display="none";
            loading.style.display="flex";
            const formData = new FormData();
            formData.append("excel_file", fileInput.files[0]);
            formData.append("feature_type", type);
            formData.append("model", model);
            fetch("{% url 'feature_engineering' %}", { method:"POST", headers:{"X-CSRFToken":csrfToken}, body:formData })
            .then(r=>r.json()).then(data=>{
                loading.style.display="none";
                if(data.status==="ok" && data.image_url){ img.src=data.image_url; img.style.display="block"; }
                else{ alert("Error: "+(data.message||"Invalid response"));}
            }).catch(err=>{ loading.style.display="none"; alert("Network/JS Error: "+err.message); });
        });
    }
</script>
</body>
</html>
